<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>STP Operators Workspace â€” Final</title>

<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg:#f4f6f7; --card:#ffffff; --muted:#eef1f2; --soft:#6b7280;
  --green:#2f855a; --brown:#6b4c3b; --radius:12px; --shadow:0 10px 28px rgba(20,20,20,0.06);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;font-family:"Montserrat",system-ui,-apple-system,"Segoe UI",Roboto,Arial;
  background:var(--bg);color:var(--brown);display:flex;justify-content:center;padding:28px;
}
.container{width:100%;max-width:1100px}
.header{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:18px}
.brand{display:flex;gap:12px;align-items:center}
.logo{width:56px;height:56px;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--brown));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
h1{font-size:1.05rem;margin:0}
.tag{color:var(--soft);font-size:0.9rem}

/* Auth */
.auth-card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);overflow:hidden}
.tab-row{display:flex}
.tab{flex:1;padding:14px;text-align:center;font-weight:700;color:#fff;cursor:pointer;user-select:none}
.tab.login{background:var(--green)} .tab.register{background:var(--green)}
.tab.dim{opacity:0.9}
.panel{padding:20px;animation:fade .35s}
.hidden{display:none}
label{display:block;margin-top:10px;font-size:0.95rem}
input,textarea,select,button{width:100%;padding:10px;margin-top:8px;border-radius:10px;border:1px solid #ddd}
textarea{min-height:90px;resize:vertical}
button.primary{background:var(--green);color:#fff;border:0;font-weight:700;padding:10px;border-radius:10px;cursor:pointer}
button.ghost{background:transparent;border:1px solid #d5d7d8;padding:9px;border-radius:10px;cursor:pointer}
.note{color:var(--soft);font-size:0.95rem;margin-top:8px}
.success{color:var(--green);font-weight:700;margin-top:8px}
.small{font-size:0.9rem;color:var(--soft)}

@keyframes fade{from{opacity:0}to{opacity:1}}

/* App layout */
.app{display:none;margin-top:18px}
.layout{display:grid;grid-template-columns:260px 1fr;gap:20px;align-items:start}
@media(max-width:900px){ .layout{grid-template-columns:1fr} }

/* Sidebar */
.sidebar{background:var(--white);color:black;border-radius:12px;padding:12px;min-height:60vh;position:relative;transition:transform .28s}
.sidebar.collapsed{transform:translateX(-1%)}
.brand-mini{display:flex;gap:10px;align-items:center;padding:6px 0}
.nav{margin-top:12px;display:flex;flex-direction:column;gap:6px}
.nav button{background:transparent;border:0;color:inherit;padding:10px 12px;text-align:left;border-radius:8px;cursor:pointer;font-weight:700}
.nav button.active{background:linear-gradient(90deg,var(--green),var(--brown));color:white}
.nav button:focus{outline:3px solid rgba(47,133,90,0.18)}

/* Main */
.main{background:var(--card);border-radius:12px;padding:18px;box-shadow:var(--shadow)}
.topbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-bottom:12px}
.toggle{background:var(--green);color:white;border:0;padding:8px 12px;border-radius:10px;cursor:pointer;font-weight:700}
.section{margin-top:12px}.card{background:var(--muted);padding:12px;border-radius:10px;border:1px solid #eee;margin-bottom:12px}
.item{background:var(--card);padding:12px;border-radius:10px;border:1px solid #eee;margin-bottom:10px}
.kpi-row{display:flex;gap:12px;margin-top:12px}
.kpi{flex:1;padding:12px;border-radius:10px;background:linear-gradient(180deg,#fff,#fbfbfb);box-shadow:0 4px 10px rgba(0,0,0,0.04);border:1px solid #eee}
.kpi strong{display:block;font-size:1.2rem}
.footer{margin-top:18px;color:var(--soft);text-align:center;font-size:0.9rem}
.row{display:flex;gap:10px;align-items:center}
.select-inline{width:auto;padding:8px;border-radius:8px;border:1px solid #ddd}
.table{width:100%;border-collapse:collapse}
.table th,.table td{padding:8px;border:1px solid #e6e6e6;text-align:left}
.actions button{margin-right:6px}
@media(max-width:720px){ .topbar{flex-direction:column;align-items:flex-start} }
</style>
</head>
<body>
  <div class="container" role="application">
    <div class="header">
      <div class="brand" aria-hidden="true">
        <div class="logo">STP</div>
        <div>
          <h1>STP Operators Workspace</h1>
          <div class="tag">Announcements Â· Material Requests Â· Documents Â· Payslips</div>
        </div>
      </div>
      <div id="userBadge" aria-live="polite"></div>
    </div>

    <!-- AUTH -->
    <div class="auth-card" id="authCard" aria-labelledby="authTitle">
      <div class="tab-row" role="tablist">
        <div id="tabLogin" class="tab login" role="tab" aria-selected="true">Login</div>
        <div id="tabRegister" class="tab register dim" role="tab" aria-selected="false">Register</div>
      </div>

      <div id="panelLogin" class="panel" aria-hidden="false">
        <h2 id="authTitle" style="margin:0 0 6px 0">Sign in</h2>
        <div class="note">Admin is preconfigured. Operators register using the Register tab.</div>

        <form id="loginForm">
          <label for="loginEmail">Email</label>
          <input id="loginEmail" type="email" autocomplete="username" required>

          <label for="loginPw">Password</label>
          <input id="loginPw" type="password" autocomplete="current-password" minlength="6" required>

          <div style="display:flex;gap:10px;margin-top:12px">
            <button class="primary" type="submit">Sign in</button>
            <button type="button" class="ghost" id="gotoRegister">Create account</button>
          </div>
          <div id="loginMsg" class="small" role="status" aria-live="polite"></div>
        </form>
      </div>

      <div id="panelRegister" class="panel hidden" aria-hidden="true">
        <h2 style="margin:0 0 6px 0">Operator Registration</h2>
        <div class="note">Operators create accounts here. After registering you remain on this tab and see a success message.</div>

        <form id="registerForm">
          <label for="regName">Full name</label>
          <input id="regName" type="text" required>

          <label for="regEmail">Email</label>
          <input id="regEmail" type="email" autocomplete="email" required>

          <label for="regPw">Password (min 6 chars)</label>
          <input id="regPw" type="password" minlength="6" required>

          <div style="display:flex;gap:10px;margin-top:12px">
            <button class="primary" id="registerBtn" type="submit">Register</button>
            <button type="button" class="ghost" id="backToLogin">Back to login</button>
          </div>
          <div id="regMsg" class="success" role="status" aria-live="polite"></div>
        </form>
      </div>
    </div>

    <!-- APP -->
    <div class="app" id="appArea" aria-hidden="true">
      <div class="layout">
        <!-- Sidebar -->
        <aside class="sidebar collapsed" id="sidebar" aria-label="Main sidebar">
          <div class="brand-mini" style="padding-bottom:8px">
            <div style="width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--green),var(--brown));display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700">STP</div>
            <div style="font-weight:700">Workspace</div>
          </div>

          <nav class="nav" aria-label="Workspace navigation">
            <button id="navDashboard">Dashboard</button>
            <button id="navAnnouncements">Announcements</button>
            <button id="navRequests">Material Requests</button>
            <button id="navDocs">Document Status</button>
            <button id="navPayslips">Payslip Requests</button>
            <button id="navOperators" style="display:none">Operators</button>
            <button id="navLogout">Logout</button>
          </nav>

          <div style="position:absolute;bottom:12px;left:12px;font-size:0.9rem;color:rgba(255,255,255,0.85)">&copy; STP</div>
        </aside>

        <!-- Main -->
        <main class="main" id="main">
          <div class="topbar">
            <div id="welcome"></div>
            <div>
              <button class="toggle" id="toggleBtn">â˜° Menu</button>
            </div>
          </div>

          <!-- Dashboard (admin only) -->
          <section id="secDashboard" class="section hidden">
            <h3>Dashboard</h3>
            <div class="kpi-row">
              <div class="kpi"><strong id="kpiAnnouncements">0</strong>Announcements</div>
              <div class="kpi"><strong id="kpiRequests">0</strong>Total Requests</div>
              <div class="kpi"><strong id="kpiDocs">0</strong>Documents</div>
              <div class="kpi"><strong id="kpiPayslips">0</strong>Payslip Requests</div>
              <div class="kpi"><strong id="kpiOperators">0</strong>Operators</div>
            </div>
            <div style="margin-top:12px" id="dashboardDetails"></div>
          </section>

          <!-- Announcements -->
          <section id="secAnnouncements" class="section hidden">
            <h3>Announcements</h3>
            <div id="annCards"></div>

            <div id="adminAnnForm" class="card hidden">
              <label for="annTitle">Title</label>
              <input id="annTitle" type="text" placeholder="Title">
              <label for="annBody">Body</label>
              <textarea id="annBody" placeholder="Details..."></textarea>
              <div style="display:flex;gap:10px;margin-top:8px">
                <button class="primary" id="postAnn">Add Announcement</button>
                <button class="ghost" id="clearAnn">Clear</button>
              </div>
            </div>
          </section>

          <!-- Material Requests -->
          <section id="secRequests" class="section hidden">
            <h3>Material Requests</h3>
            <div id="reqCards"></div>

            <div id="operatorReqForm" class="card hidden">
              <label for="reqItem">Item / Description</label>
              <input id="reqItem" type="text" placeholder="e.g. Filter element">
              <label for="reqQty">Quantity</label>
              <input id="reqQty" type="number" min="1" value="1">
              <label for="reqNote">Notes</label>
              <textarea id="reqNote" placeholder="Any notes..."></textarea>
              <div style="display:flex;gap:10px;margin-top:8px">
                <button class="primary" id="submitReq">Submit Request</button>
                <button class="ghost" id="clearReq">Clear</button>
              </div>
            </div>

            <div id="adminReqControls" class="card hidden">
              <div class="small">Admin quick actions</div>
              <div style="display:flex;gap:10px;margin-top:8px">
                <button class="primary" id="approveAll">Approve all Requested</button>
                <button class="ghost" id="setOutForDeliveryAll">Set all Out for Delivery</button>
              </div>
            </div>
          </section>

          <!-- Documents -->
          <section id="secDocs" class="section hidden">
            <h3>Document Status</h3>
            <div id="docCards"></div>

            <div id="adminDocForm" class="card hidden">
              <label for="docName">Document name</label>
              <input id="docName" type="text" placeholder="Permit / Report">
              <label for="docStatus">Status</label>
              <select id="docStatus">
                <option>Pending</option>
                <option>Submitted</option>
                <option>Reviewed</option>
                <option>Approved</option>
              </select>
              <div style="display:flex;gap:10px;margin-top:8px">
                <button class="primary" id="addDoc">Add / Update</button>
                <button class="ghost" id="clearDoc">Clear</button>
              </div>
            </div>
          </section>

          <!-- Payslips -->
          <section id="secPayslips" class="section hidden">
            <h3>Payslip Requests</h3>
            <div id="payslipCards"></div>

            <div id="operatorPayslipForm" class="card hidden">
              <label for="psMonth">Month</label>
              <select id="psMonth">
                <option value="">Select month</option>
                <option>January</option><option>February</option><option>March</option><option>April</option>
                <option>May</option><option>June</option><option>July</option><option>August</option>
                <option>September</option><option>October</option><option>November</option><option>December</option>
              </select>

              <label for="psCutoff">Cut-off</label>
              <select id="psCutoff">
                <option value="">Select cut-off</option>
                <option>1st</option>
                <option>2nd</option>
              </select>

              <div style="display:flex;gap:10px;margin-top:8px">
                <button class="primary" id="submitPayslip">Request Payslip</button>
                <button class="ghost" id="clearPayslip">Clear</button>
              </div>
            </div>
          </section>

        </main>
      </div>

      <div class="footer">Data stored in Firebase Realtime Database. Secure rules recommended for production.</div>
    </div>

    <div class="footer" style="margin-top:18px">Design: Modern Minimal â€” white / grey / green / brown Â· Fonts: Montserrat, Acumin Pro</div>
  </div>

<!-- Firebase compat libraries -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

<script>
/* ==============
   Firebase config - already set with your keys.
   IMPORTANT: If your Realtime DB URL differs, replace databaseURL below.
   Example DB URL: https://workspace-1cf42-default-rtdb.firebaseio.com
   ============== */
const firebaseConfig = {
  apiKey: "AIzaSyBM6K8zz8WNYtU7NHRMKp-qrVCWoxU8hGw",
  authDomain: "workspace-1cf42.firebaseapp.com",
  databaseURL: "https://workspace-1cf42-default-rtdb.firebaseio.com",
  projectId: "workspace-1cf42",
  storageBucket: "workspace-1cf42.firebasestorage.app",
  messagingSenderId: "113015937389",
  appId: "1:113015937389:web:a75cfaf9f767fd4e90e264",
  measurementId: "G-NHGX7PKSSV"
};

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.database();

/* Fixed admin credentials (exclusive) */
const ADMIN_EMAIL = 'jmonterona.miraga@gmail.com';
const ADMIN_PW = 'jmonterona060801';

/* UI refs */
const tabLogin = document.getElementById('tabLogin');
const tabRegister = document.getElementById('tabRegister');
const panelLogin = document.getElementById('panelLogin');
const panelRegister = document.getElementById('panelRegister');
const gotoRegister = document.getElementById('gotoRegister');
const backToLogin = document.getElementById('backToLogin');
const authCard = document.getElementById('authCard');
const appArea = document.getElementById('appArea');
const sidebar = document.getElementById('sidebar');

const loginForm = document.getElementById('loginForm');
const registerForm = document.getElementById('registerForm');
const loginMsg = document.getElementById('loginMsg');
const regMsg = document.getElementById('regMsg');

const userBadge = document.getElementById('userBadge');
const welcomeEl = document.getElementById('welcome');

const navDashboard = document.getElementById('navDashboard');
const navAnnouncements = document.getElementById('navAnnouncements');
const navRequests = document.getElementById('navRequests');
const navDocs = document.getElementById('navDocs');
const navPayslips = document.getElementById('navPayslips');
const navOperators = document.getElementById('navOperators');
const navLogout = document.getElementById('navLogout');
const toggleBtn = document.getElementById('toggleBtn');

/* Sections & forms */
const secDashboard = document.getElementById('secDashboard');
const secAnnouncements = document.getElementById('secAnnouncements');
const secRequests = document.getElementById('secRequests');
const secDocs = document.getElementById('secDocs');
const secPayslips = document.getElementById('secPayslips');

const adminAnnForm = document.getElementById('adminAnnForm');
const annCards = document.getElementById('annCards');
const postAnnBtn = document.getElementById('postAnn');
const clearAnnBtn = document.getElementById('clearAnn');
const annTitle = document.getElementById('annTitle');
const annBody = document.getElementById('annBody');

const reqCards = document.getElementById('reqCards');
const operatorReqForm = document.getElementById('operatorReqForm');
const submitReqBtn = document.getElementById('submitReq');
const clearReqBtn = document.getElementById('clearReq');
const reqItem = document.getElementById('reqItem');
const reqQty = document.getElementById('reqQty');
const reqNote = document.getElementById('reqNote');

const adminReqControls = document.getElementById('adminReqControls');
const approveAllBtn = document.getElementById('approveAll');
const outForDeliveryAllBtn = document.getElementById('setOutForDeliveryAll');

const docCards = document.getElementById('docCards');
const adminDocForm = document.getElementById('adminDocForm');
const addDocBtn = document.getElementById('addDoc');
const clearDocBtn = document.getElementById('clearDoc');
const docName = document.getElementById('docName');
const docStatus = document.getElementById('docStatus');

const payslipCards = document.getElementById('payslipCards');
const operatorPayslipForm = document.getElementById('operatorPayslipForm');
const submitPayslipBtn = document.getElementById('submitPayslip');
const clearPayslipBtn = document.getElementById('clearPayslip');
const psMonth = document.getElementById('psMonth');
const psCutoff = document.getElementById('psCutoff');

/* Dashboard KPIs */
const kpiAnnouncements = document.getElementById('kpiAnnouncements');
const kpiRequests = document.getElementById('kpiRequests');
const kpiDocs = document.getElementById('kpiDocs');
const kpiPayslips = document.getElementById('kpiPayslips');
const kpiOperators = document.getElementById('kpiOperators');
const dashboardDetails = document.getElementById('dashboardDetails');

/* state */
let currentUser = null; // { role: 'admin' } or { uid, email, name, role:'operator' }

/* Ensure Firebase Auth persistence for operators */
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(e=>console.warn('persistence failed', e));

/* Tab switching */
tabLogin.addEventListener('click', ()=> switchTab('login'));
tabRegister.addEventListener('click', ()=> switchTab('register'));
gotoRegister.addEventListener('click', ()=> switchTab('register'));
backToLogin.addEventListener('click', ()=> switchTab('login'));
function switchTab(which){
  if(which === 'login'){
    panelLogin.classList.remove('hidden'); panelRegister.classList.add('hidden');
    tabLogin.classList.remove('dim'); tabRegister.classList.add('dim');
  } else {
    panelLogin.classList.add('hidden'); panelRegister.classList.remove('hidden');
    tabLogin.classList.add('dim'); tabRegister.classList.remove('dim');
  }
  loginMsg.textContent=''; regMsg.textContent='';
}

/* --- Admin session persistence (localStorage) ---
   We store a flag so admin remains signed-in across refresh.
*/
const ADMIN_SESSION_KEY = 'stp_admin_session';
function setAdminSession(on){
  if(on) localStorage.setItem(ADMIN_SESSION_KEY, '1');
  else localStorage.removeItem(ADMIN_SESSION_KEY);
}
function isAdminSession(){
  return localStorage.getItem(ADMIN_SESSION_KEY) === '1';
}

/* Login (admin local or operator via Firebase Auth) */
loginForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  loginMsg.textContent = '';
  const email = document.getElementById('loginEmail').value.trim().toLowerCase();
  const pw = document.getElementById('loginPw').value;

  if(email === ADMIN_EMAIL){
    if(pw === ADMIN_PW){
      currentUser = { role: 'admin', email: ADMIN_EMAIL, name: 'Admin' };
      setAdminSession(true);
      openWorkspace();
      loginMsg.textContent = 'Signed in as admin';
    } else {
      loginMsg.textContent = 'Incorrect admin password';
    }
    return;
  }

  try{
    const cred = await auth.signInWithEmailAndPassword(email, pw);
    const uid = cred.user.uid;
    const snapshot = await db.ref('users/' + uid).once('value');
    const profile = snapshot.val();
    currentUser = { uid, email: profile?.email || email, name: profile?.name || email, role: profile?.role || 'operator' };
    openWorkspace();
    loginMsg.textContent = 'Signed in';
  } catch(err){
    console.error(err); loginMsg.textContent = err.message || 'Sign-in failed';
  }
});

/* Register (operators) - remain on page with success message */
registerForm.addEventListener('submit', async (e)=>{
  e.preventDefault();
  regMsg.textContent = '';
  const name = document.getElementById('regName').value.trim();
  const email = document.getElementById('regEmail').value.trim().toLowerCase();
  const pw = document.getElementById('regPw').value;
  if(!name || !email || !pw){ regMsg.textContent = 'Enter full name, email & password'; return; }
  if(email === ADMIN_EMAIL){ regMsg.textContent = 'Admin account is reserved and cannot be registered.'; return; }
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pw);
    const uid = cred.user.uid;
    await db.ref('users/' + uid).set({ name, email, role: 'operator', createdAt: Date.now() });
    regMsg.textContent = 'Operator account created successfully. Please sign in using the Login tab.';
    registerForm.reset();
  } catch(err){
    console.error(err); regMsg.textContent = err.message || 'Registration failed';
  }
});

/* Open workspace for currentUser and configure UI by role */
function openWorkspace(){
  authCard.style.display = 'none';
  appArea.style.display = 'block';
  appArea.setAttribute('aria-hidden','false');
  updateUserBadge();
  configureForRole(currentUser.role);
  sidebar.classList.add('collapsed');

  // Attach realtime listeners (ensure they are active after login)
  attachRealtimeListeners();

  // Default view
  if(currentUser.role === 'admin'){ setActiveNav(navDashboard); showDashboard(); }
  else { setActiveNav(navAnnouncements); showAnnouncements(); }
}

/* Update top badge */
function updateUserBadge(){
  userBadge.innerHTML = currentUser ? `<div class="badge">${escape(currentUser.name || currentUser.email)} (${escape(currentUser.role)})</div>` : '';
  welcomeEl.innerHTML = currentUser ? `<div style="font-weight:700">Welcome â€” ${escape(currentUser.name || currentUser.email)}</div>` : '';
}

/* Configure UI by role */
function configureForRole(role){
  const isAdmin = role === 'admin';
  navDashboard.style.display = isAdmin ? 'block' : 'none';
  navOperators.style.display = isAdmin ? 'block' : 'none';

  adminAnnForm.classList.toggle('hidden', !isAdmin);
  adminReqControls.classList.toggle('hidden', !isAdmin);
  adminDocForm.classList.toggle('hidden', !isAdmin);

  operatorReqForm.classList.toggle('hidden', isAdmin);
  operatorPayslipForm.classList.toggle('hidden', isAdmin);
}

/* Sidebar nav wiring */
toggleBtn.addEventListener('click', ()=> sidebar.classList.toggle('open'));
navDashboard.addEventListener('click', ()=>{ setActiveNav(navDashboard); showDashboard(); });
navAnnouncements.addEventListener('click', ()=>{ setActiveNav(navAnnouncements); showAnnouncements(); });
navRequests.addEventListener('click', ()=>{ setActiveNav(navRequests); showRequests(); });
navDocs.addEventListener('click', ()=>{ setActiveNav(navDocs); showDocs(); });
navPayslips.addEventListener('click', ()=>{ setActiveNav(navPayslips); showPayslips(); });
navOperators.addEventListener('click', ()=>{ setActiveNav(navOperators); showOperators(); });
navLogout.addEventListener('click', logout);

function setActiveNav(btn){
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}

/* Logout */
async function logout(){
  try{ await auth.signOut(); }catch(e){/*ignore*/ }
  setAdminSession(false);
  currentUser = null;
  appArea.style.display = 'none';
  authCard.style.display = 'block';
  switchTab('login');
}

/* Helpers */
function escape(s){ if(!s) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* Realtime listeners & CRUD */
let listenersAttached = false;
function attachRealtimeListeners(){
  if(listenersAttached) return;
  listenersAttached = true;

  db.ref('announcements').on('value', snapshot => {
    const val = snapshot.val() || {};
    renderAnnouncements(val);
    renderDashboardCounts();
  });

  db.ref('materials').on('value', snapshot => {
    const val = snapshot.val() || {};
    renderMaterials(val);
    renderDashboardCounts();
  });

  db.ref('documents').on('value', snapshot => {
    const val = snapshot.val() || {};
    renderDocuments(val);
    renderDashboardCounts();
  });

  db.ref('payslips').on('value', snapshot => {
    const val = snapshot.val() || {};
    renderPayslips(val);
    renderDashboardCounts();
  });

  db.ref('users').on('value', snapshot => {
    const val = snapshot.val() || {};
    renderOperators(val);
    renderDashboardCounts();
  });
}

/* ===== Announcements ===== */
postAnnBtn.addEventListener('click', async ()=>{
  const title = annTitle.value.trim();
  const body = annBody.value.trim();
  if(!title && !body){ alert('Enter title or body'); return; }
  const refNode = db.ref('announcements').push();
  await refNode.set({ id: refNode.key, title, body, author: currentUser.email, ts: Date.now() });
  annTitle.value=''; annBody.value='';
});
clearAnnBtn.addEventListener('click', ()=>{ annTitle.value=''; annBody.value=''; });

function renderAnnouncements(obj){
  annCards.innerHTML = '';
  const entries = Object.values(obj).sort((a,b)=> (b.ts||0)-(a.ts||0));
  if(!entries.length){ annCards.innerHTML = '<div class="item small">No announcements yet.</div>'; return; }
  entries.forEach(a=>{
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div style="font-weight:700">${escape(a.title||'Untitled')}</div>
                    <div class="small">${new Date((a.ts||0)).toLocaleString()} â€¢ ${escape(a.author||'')}</div>
                    <div style="margin-top:8px">${escape(a.body)}</div>
                    ${ currentUser && currentUser.role==='admin' ? `<div style="margin-top:8px"><button class="ghost" onclick="removeAnnouncement('${a.id}')">Remove</button></div>` : '' }`;
    annCards.appendChild(el);
  });
}
window.removeAnnouncement = async (id) => { if(!confirm('Remove announcement?')) return; await db.ref('announcements/' + id).remove(); };

/* ===== Materials ===== */
submitReqBtn.addEventListener('click', async ()=>{
  const item = reqItem.value.trim();
  const qty = parseInt(reqQty.value) || 1;
  const note = reqNote.value.trim();
  if(!item){ alert('Enter item'); return; }
  const refNode = db.ref('materials').push();
  await refNode.set({ id: refNode.key, item, qty, note, by: currentUser.email, uid: currentUser.uid || null, status: 'Requested', ts: Date.now() });
  reqItem.value=''; reqQty.value='1'; reqNote.value='';
});
clearReqBtn.addEventListener('click', ()=>{ reqItem.value=''; reqQty.value='1'; reqNote.value=''; });

function renderMaterials(obj){
  reqCards.innerHTML = '';
  const entries = Object.values(obj).sort((a,b)=> (b.ts||0)-(a.ts||0));
  if(!entries.length){ reqCards.innerHTML = '<div class="item small">No requests yet.</div>'; return; }
  entries.forEach(r=>{
    if(currentUser.role !== 'admin' && r.uid !== (currentUser.uid || null)) return;
    const el = document.createElement('div'); el.className='item';
    let controls = '';
    if(currentUser && currentUser.role === 'admin'){
      controls = `<div style="margin-top:8px" class="row">
                    <div>
                      <select class="select-inline" onchange="changeReqStatus('${r.id}', this.value)">
                        <option ${r.status==='Requested'?'selected':''}>Requested</option>
                        <option ${r.status==='Approved'?'selected':''}>Approved</option>
                        <option ${r.status==='Rejected'?'selected':''}>Rejected</option>
                        <option ${r.status==='Out for Delivery'?'selected':''}>Out for Delivery</option>
                      </select>
                    </div>
                    <div class="actions"><button class="ghost" onclick="removeRequest('${r.id}')">Remove</button></div>
                  </div>`;
    } else {
      const statusBadge = r.status === 'Requested' ? 'ðŸŸ¡ Requested' : r.status === 'Approved' ? 'ðŸŸ¢ Approved' : r.status === 'Out for Delivery' ? 'ðŸšš Out for Delivery' : 'â›” Rejected';
      controls = `<div class="small">Status: <strong>${statusBadge}</strong></div>`;
    }
    el.innerHTML = `<div style="font-weight:700">${escape(r.item)}</div>
                    <div class="small">Qty: ${escape(String(r.qty))} â€¢ Requested by: ${escape(r.by)} â€¢ ${new Date((r.ts||0)).toLocaleString()}</div>
                    <div style="margin-top:8px">${escape(r.note||'')}</div>
                    ${controls}`;
    reqCards.appendChild(el);
  });
}
window.changeReqStatus = async (id, value) => { await db.ref('materials/' + id).update({ status: value }); };
window.removeRequest = async (id) => { if(!confirm('Remove request?')) return; await db.ref('materials/' + id).remove(); };
approveAllBtn.addEventListener('click', async ()=>{ if(!confirm('Approve all Requested requests?')) return; const snapshot = await db.ref('materials').once('value'); const obj = snapshot.val() || {}; for(const id in obj){ if(obj[id].status === 'Requested') await db.ref('materials/' + id).update({ status: 'Approved' }); } });
outForDeliveryAllBtn.addEventListener('click', async ()=>{ if(!confirm('Set all Approved to Out for Delivery?')) return; const snapshot = await db.ref('materials').once('value'); const obj = snapshot.val() || {}; for(const id in obj){ if(obj[id].status === 'Approved') await db.ref('materials/' + id).update({ status: 'Out for Delivery' }); } });

/* ===== Documents ===== */
addDocBtn.addEventListener('click', async ()=>{
  const name = docName.value.trim();
  const status = docStatus.value;
  if(!name){ alert('Enter document name'); return; }
  const refNode = db.ref('documents').push();
  await refNode.set({ id: refNode.key, name, status, author: currentUser.email, ts: Date.now() });
  docName.value=''; docStatus.selectedIndex=0;
});
clearDocBtn.addEventListener('click', ()=>{ docName.value=''; docStatus.selectedIndex=0; });

function renderDocuments(obj){
  docCards.innerHTML = '';
  const entries = Object.values(obj).sort((a,b)=> (b.ts||0)-(a.ts||0));
  if(!entries.length){ docCards.innerHTML = '<div class="item small">No documents tracked.</div>'; return; }
  entries.forEach(d=>{
    const el = document.createElement('div'); el.className='item';
    el.innerHTML = `<div style="font-weight:700">${escape(d.name)}</div>
                    <div class="small">Status: ${escape(d.status)} â€¢ ${new Date((d.ts||0)).toLocaleString()}</div>
                    ${ currentUser && currentUser.role==='admin' ? `<div style="margin-top:8px"><button class="ghost" onclick="removeDocument('${d.id}')">Remove</button></div>` : '' }`;
    docCards.appendChild(el);
  });
}
window.removeDocument = async (id)=>{ if(!confirm('Remove document?')) return; await db.ref('documents/' + id).remove(); };

/* ===== Payslips ===== */
submitPayslipBtn.addEventListener('click', async ()=>{
  const month = psMonth.value;
  const cutoff = psCutoff.value;
  if(!month || !cutoff){ alert('Select month and cut-off'); return; }
  const refNode = db.ref('payslips').push();
  await refNode.set({ id: refNode.key, name: currentUser.name || currentUser.email, email: currentUser.email, month, cutoff, status: 'Pending', ts: Date.now() });
  psMonth.selectedIndex = 0; psCutoff.selectedIndex = 0;
});
clearPayslipBtn.addEventListener('click', ()=>{ psMonth.selectedIndex=0; psCutoff.selectedIndex=0; });

function renderPayslips(obj){
  payslipCards.innerHTML = '';
  const entries = Object.values(obj).sort((a,b)=> (b.ts||0)-(a.ts||0));
  if(!entries.length){ payslipCards.innerHTML = '<div class="item small">No payslip requests.</div>'; return; }
  entries.forEach(p=>{
    if(currentUser.role !== 'admin' && p.email !== currentUser.email) return;
    const el = document.createElement('div'); el.className='item';
    let controls = '';
    if(currentUser && currentUser.role==='admin'){
      controls = `<div style="margin-top:8px" class="row">
                    <div><select class="select-inline" onchange="changePayslipStatus('${p.id}', this.value)">
                      <option ${p.status==='Pending'?'selected':''}>Pending</option>
                      <option ${p.status==='Approved'?'selected':''}>Approved</option>
                      <option ${p.status==='Ready for Pickup'?'selected':''}>Ready for Pickup</option>
                    </select></div>
                    <div class="actions"><button class="ghost" onclick="removePayslip('${p.id}')">Remove</button></div>
                  </div>`;
    } else {
      controls = `<div class="small">Status: <strong>${escape(p.status)}</strong></div>`;
    }
    el.innerHTML = `<div style="font-weight:700">${escape(p.name || p.email)}</div>
                    <div class="small">${escape(p.email)} â€¢ ${escape(p.month)} â€¢ Cut-off: ${escape(p.cutoff)} â€¢ ${new Date((p.ts||0)).toLocaleString()}</div>
                    ${controls}`;
    payslipCards.appendChild(el);
  });
}
window.changePayslipStatus = async (id, value)=>{ await db.ref('payslips/' + id).update({ status: value }); }
window.removePayslip = async (id)=>{ if(!confirm('Remove payslip request?')) return; await db.ref('payslips/' + id).remove(); }

/* ===== Operators list (admin) ===== */
function renderOperators(obj){
  // navOperators is shown only to admin; full operator table can be implemented if needed
}

/* ===== Dashboard counts ===== */
function renderDashboardCounts(){
  Promise.all([
    db.ref('announcements').once('value'),
    db.ref('materials').once('value'),
    db.ref('documents').once('value'),
    db.ref('payslips').once('value'),
    db.ref('users').once('value')
  ]).then(([a,m,d,p,u])=>{
    const ann = a.val() || {}; const mat = m.val() || {}; const doc = d.val() || {}; const pays = p.val() || {}; const users = u.val() || {};
    kpiAnnouncements.textContent = Object.keys(ann).length || 0;
    kpiRequests.textContent = Object.keys(mat).length || 0;
    kpiDocs.textContent = Object.keys(doc).length || 0;
    kpiPayslips.textContent = Object.keys(pays).length || 0;
    kpiOperators.textContent = Object.values(users).filter(x=>x.role==='operator').length || 0;

    const byStatus = Object.values(mat).reduce((acc, r) => { acc[r.status] = (acc[r.status]||0)+1; return acc; }, {});
    dashboardDetails.innerHTML = `<div class="card"><div><strong>Requests by status</strong></div><div class="small">Requested: ${byStatus['Requested']||0} â€¢ Approved: ${byStatus['Approved']||0} â€¢ Out for Delivery: ${byStatus['Out for Delivery']||0} â€¢ Rejected: ${byStatus['Rejected']||0}</div></div>`;
  }).catch(err=>{ console.warn(err); });
}

/* Views */
function hideAllSections(){ document.querySelectorAll('.section').forEach(s=>s.classList.add('hidden')); }
function showDashboard(){ hideAllSections(); secDashboard.classList.remove('hidden'); renderDashboardCounts(); }
function showAnnouncements(){ hideAllSections(); secAnnouncements.classList.remove('hidden'); }
function showRequests(){ hideAllSections(); secRequests.classList.remove('hidden'); }
function showDocs(){ hideAllSections(); secDocs.classList.remove('hidden'); }
function showPayslips(){ hideAllSections(); secPayslips.classList.remove('hidden'); }
function showOperators(){ hideAllSections(); }

/* Restore session: operator via Firebase, admin via localStorage */
auth.onAuthStateChanged(async user => {
  if(user){
    const snapshot = await db.ref('users/' + user.uid).once('value');
    const profile = snapshot.val() || {};
    currentUser = { uid: user.uid, email: user.email, name: profile.name || user.email, role: profile.role || 'operator' };
    openWorkspace();
  } else {
    // no firebase user; check admin session in localStorage
    if(isAdminSession()){
      currentUser = { role: 'admin', email: ADMIN_EMAIL, name: 'Admin' };
      openWorkspace();
    } else {
      authCard.style.display = 'block';
      appArea.style.display = 'none';
      switchTab('login');
    }
  }
});

/* init */
(function init(){
  document.querySelectorAll('.nav button').forEach(b=>b.addEventListener('click', ()=>{ document.querySelectorAll('.nav button').forEach(x=>x.classList.remove('active')); b.classList.add('active'); }));
  document.getElementById('toggleBtn').addEventListener('click', ()=> sidebar.classList.toggle('open'));
})();
</script>
</body>
</html>
